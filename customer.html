<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A-1APSVC • Customer Profile</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --muted:#93a4c7;
      --text:#e7eefc;
      --accent:#4da3ff;
      --danger:#ff5a6a;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#0b1220,#182a4a);
      color:var(--text);
    }

    header{
      position:sticky; top:0;
      background:rgba(11,18,32,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:14px 16px;
      z-index:10;
    }

    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    h1{ margin:0 0 6px; font-size:22px; font-weight:800; }
    p{ margin:0; color:var(--muted); }

    .btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ border-color:rgba(255,255,255,.30); }
    .btnPrimary{
      background:rgba(77,163,255,.16);
      border-color:rgba(77,163,255,.40);
    }
    .btnDanger{
      background:rgba(255,90,106,.15);
      border-color:rgba(255,90,106,.40);
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .card{
      background:rgba(17,27,46,.9);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px;
      margin-top:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.25);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px 16px; /* ✅ fixes “fields on top of each other” */
      margin-top:10px;
    }
    .full{ grid-column: 1 / -1; }

    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    input{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    input::placeholder{ color:rgba(231,238,252,.55); }

    .actions{
      display:flex;
      gap:10px;
      margin-top:16px;
      flex-wrap:wrap;
    }

    .error{
      background:rgba(255,90,106,.12);
      border:1px solid rgba(255,90,106,.35);
      color:#ffd3d8;
      padding:12px;
      border-radius:14px;
      margin-top:16px;
      display:none;
    }
    .ok{
      background:rgba(77,163,255,.12);
      border:1px solid rgba(77,163,255,.35);
      color:#d7ecff;
      padding:12px;
      border-radius:14px;
      margin-top:16px;
      display:none;
    }

    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      .full{ grid-column: auto; }
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="title">Customer Profile</h1>
        <p id="subtitle">Loading…</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="./customers.html">← Back to Customers</a>
        <a class="btn" href="./index.html">Dashboard</a>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="msgError" class="error"></div>
  <div id="msgOk" class="ok"></div>

  <div class="card">
    <div class="grid">
      <div class="field">
        <label>First Name</label>
        <input id="first_name" placeholder="First name" />
      </div>
      <div class="field">
        <label>Last Name</label>
        <input id="last_name" placeholder="Last name" />
      </div>

      <div class="field">
        <label>Email</label>
        <input id="email" placeholder="email@domain.com" />
      </div>
      <div class="field">
        <label>Mobile Phone</label>
        <input id="mobile_phone" placeholder="(###) ###-####" />
      </div>

      <div class="field">
        <label>Home Phone</label>
        <input id="home_phone" placeholder="(###) ###-####" />
      </div>
      <div class="field">
        <label>Work Phone</label>
        <input id="work_phone" placeholder="(###) ###-####" />
      </div>

      <div class="field full">
        <label>Address</label>
        <input id="address" placeholder="Street, City, State ZIP" />
      </div>
    </div>

    <div class="actions">
      <button class="btn btnPrimary" id="btnSave" type="button">Save Changes</button>
      <button class="btn btnDanger" id="btnDelete" type="button">Delete Customer</button>
    </div>
  </div>
</main>

<!-- IMPORTANT:
     customer-data.js is a module and exposes functions on window.*
     So we must load it as type="module" BEFORE our inline script uses them. -->
<script type="module" src="./customer-data.js"></script>

<script>
  const qs = new URLSearchParams(location.search);
  const id = qs.get("id");

  const msgError = document.getElementById("msgError");
  const msgOk = document.getElementById("msgOk");

  const title = document.getElementById("title");
  const subtitle = document.getElementById("subtitle");

  const first_name = document.getElementById("first_name");
  const last_name = document.getElementById("last_name");
  const email = document.getElementById("email");
  const mobile_phone = document.getElementById("mobile_phone");
  const home_phone = document.getElementById("home_phone");
  const work_phone = document.getElementById("work_phone");
  const address = document.getElementById("address");

  const btnSave = document.getElementById("btnSave");
  const btnDelete = document.getElementById("btnDelete");

  function showErr(msg){
    msgError.textContent = msg;
    msgError.style.display = "block";
  }
  function clearErr(){
    msgError.style.display = "none";
    msgError.textContent = "";
  }
  function showOk(msg){
    msgOk.textContent = msg;
    msgOk.style.display = "block";
    setTimeout(()=>{ msgOk.style.display="none"; }, 1800);
  }

  if (!id){
    showErr("Missing customer id.");
    throw new Error("Missing id");
  }

  async function loadCustomer(){
    clearErr();

    // Guard: make sure module loaded + exported globals exist
    if (typeof window.initializeCustomerData !== "function"){
      showErr("customer-data.js did not load (initializeCustomerData missing).");
      throw new Error("initializeCustomerData missing");
    }
    if (typeof window.updateCustomerInSupabase !== "function"){
      showErr("customer-data.js did not load (updateCustomerInSupabase missing).");
      throw new Error("updateCustomerInSupabase missing");
    }
    if (typeof window.deleteCustomerInSupabase !== "function"){
      showErr("customer-data.js did not load (deleteCustomerInSupabase missing).");
      throw new Error("deleteCustomerInSupabase missing");
    }

    subtitle.textContent = "Loading…";
    btnSave.disabled = true;
    btnDelete.disabled = true;

    try{
      const list = await window.initializeCustomerData();
      const c = (list || []).find(x => String(x.id) === String(id));

      if (!c){
        showErr("Customer not found.");
        subtitle.textContent = "";
        return;
      }

      title.textContent = `${c.first_name || ""} ${c.last_name || ""}`.trim() || "Customer Profile";
      subtitle.textContent = c.email || "";

      first_name.value = c.first_name || "";
      last_name.value = c.last_name || "";
      email.value = c.email || "";
      mobile_phone.value = c.mobile_phone || "";
      home_phone.value = c.home_phone || "";
      work_phone.value = c.work_phone || "";
      address.value = c.address || "";

      btnSave.disabled = false;
      btnDelete.disabled = false;
    } catch (e){
      showErr(e?.message || "Failed to load customer.");
      subtitle.textContent = "";
    }
  }

  btnSave.addEventListener("click", async () => {
    clearErr();
    btnSave.disabled = true;

    try{
      const updated = await window.updateCustomerInSupabase(id, {
        firstName: first_name.value.trim(),
        lastName: last_name.value.trim(),
        email: email.value.trim(),
        mobilePhone: mobile_phone.value.trim(),
        homePhone: home_phone.value.trim(),
        workPhone: work_phone.value.trim(),
        address: address.value.trim()
      });

      if (!updated) throw new Error("Update failed (no row returned).");

      // Update header with new info
      title.textContent = `${updated.first_name || ""} ${updated.last_name || ""}`.trim() || "Customer Profile";
      subtitle.textContent = updated.email || "";

      showOk("Saved");
    } catch (e){
      showErr(e?.message || "Save failed.");
    } finally{
      btnSave.disabled = false;
    }
  });

  btnDelete.addEventListener("click", async () => {
    clearErr();
    const ok = confirm("Delete this customer? This cannot be undone.");
    if (!ok) return;

    btnDelete.disabled = true;

    try{
      await window.deleteCustomerInSupabase(id);
      location.href = "./customers.html";
    } catch (e){
      showErr(e?.message || "Delete failed.");
      btnDelete.disabled = false;
    }
  });

  loadCustomer();
</script>

</body>
</html>

