<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A-1APSVC • Customer Profile</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --muted:#93a4c7;
      --text:#e7eefc;
      --accent:#4da3ff;
      --danger:#ff5a6a;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#0b1220,#182a4a);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      background:rgba(11,18,32,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:14px 16px;
      z-index:10;
    }

    .wrap{ max-width:900px; margin:0 auto; padding:16px; }
    h1{ margin:0 0 6px; font-size:22px; font-weight:800; }
    p{ margin:0; color:var(--muted); }

    .btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ border-color:rgba(255,255,255,.30); }

    .btnPrimary{
      background:rgba(77,163,255,.16);
      border-color:rgba(77,163,255,.40);
    }
    .btnDanger{
      background:rgba(255,90,106,.15);
      border-color:rgba(255,90,106,.40);
    }

    .card{
      background:rgba(17,27,46,.9);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:18px;
      margin-top:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:10px;
    }
    .full{ grid-column: 1 / -1; }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    label{ font-size:12px; color:var(--muted); }

    input{
      width:100%;
      height:44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      box-sizing:border-box;
      outline:none;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:18px;
      flex-wrap:wrap;
    }

    .error{
      background:rgba(255,90,106,.12);
      border:1px solid rgba(255,90,106,.35);
      padding:12px;
      border-radius:14px;
      margin-top:16px;
      display:none;
    }

    .ok{
      background:rgba(77,163,255,.12);
      border:1px solid rgba(77,163,255,.35);
      padding:12px;
      border-radius:14px;
      margin-top:16px;
      display:none;
    }

    @media (max-width: 720px){
      .form-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div>
        <h1 id="title">Customer Profile</h1>
        <p id="subtitle">Loading…</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="./customers.html">← Back to Customers</a>
        <a class="btn" href="./index.html">Dashboard</a>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="msgError" class="error"></div>
  <div id="msgOk" class="ok"></div>

  <div class="card">
    <div class="form-grid">
      <div class="field">
        <label for="first_name">First Name</label>
        <input id="first_name" autocomplete="given-name">
      </div>

      <div class="field">
        <label for="last_name">Last Name</label>
        <input id="last_name" autocomplete="family-name">
      </div>

      <div class="field">
        <label for="email">Email</label>
        <input id="email" autocomplete="email">
      </div>

      <div class="field">
        <label for="mobile_phone">Mobile Phone</label>
        <input id="mobile_phone" autocomplete="tel">
      </div>

      <div class="field">
        <label for="home_phone">Home Phone</label>
        <input id="home_phone" autocomplete="tel">
      </div>

      <div class="field">
        <label for="work_phone">Work Phone</label>
        <input id="work_phone" autocomplete="tel">
      </div>

      <div class="field full">
        <label for="address">Address</label>
        <input id="address" placeholder="Street, City, State ZIP">
      </div>
    </div>

    <div class="actions">
      <button class="btn btnPrimary" id="btnSave" type="button">Save Changes</button>
      <button class="btn btnDanger" id="btnDelete" type="button">Delete Customer</button>
    </div>
  </div>
</main>

<script type="module">
  const $ = (id) => document.getElementById(id);

  const qs = new URLSearchParams(location.search);
  const id = qs.get("id");

  const msgError = $("msgError");
  const msgOk = $("msgOk");
  const title = $("title");
  const subtitle = $("subtitle");

  const first_name = $("first_name");
  const last_name = $("last_name");
  const email = $("email");
  const mobile_phone = $("mobile_phone");
  const home_phone = $("home_phone");
  const work_phone = $("work_phone");
  const address = $("address");

  const btnSave = $("btnSave");
  const btnDelete = $("btnDelete");

  function showError(msg){
    msgOk.style.display = "none";
    msgError.textContent = msg;
    msgError.style.display = "block";
  }

  function showOk(msg){
    msgError.style.display = "none";
    msgOk.textContent = msg;
    msgOk.style.display = "block";
    setTimeout(() => { msgOk.style.display = "none"; }, 1800);
  }

  if (!id){
    showError("Missing customer id.");
    throw new Error("Missing id");
  }

  let CURRENT = null;

  async function ensureCustomerDataLoaded(){
    // ✅ This guarantees we load the module first
    await import("./customer-data.js");

    // ✅ Then ensure globals exist
    if (typeof window.initializeCustomerData !== "function") {
      throw new Error("customer-data.js loaded, but initializeCustomerData is still missing.");
    }
  }

  async function loadCustomer(){
    try{
      await ensureCustomerDataLoaded();

      const list = await window.initializeCustomerData();
      CURRENT = (list || []).find(c => String(c.id) === String(id));

      if (!CURRENT){
        showError("Customer not found.");
        return;
      }

      title.textContent = `${CURRENT.first_name || ""} ${CURRENT.last_name || ""}`.trim() || "Customer Profile";
      subtitle.textContent = CURRENT.email || "";

      first_name.value = CURRENT.first_name || "";
      last_name.value = CURRENT.last_name || "";
      email.value = CURRENT.email || "";
      mobile_phone.value = CURRENT.mobile_phone || "";
      home_phone.value = CURRENT.home_phone || "";
      work_phone.value = CURRENT.work_phone || "";
      address.value = CURRENT.address || "";

    } catch(e){
      console.error(e);
      showError(e?.message || "Failed to load customer.");
    }
  }

  btnSave.addEventListener("click", async () => {
    try{
      await ensureCustomerDataLoaded();

      const updated = await window.updateCustomerInSupabase(id, {
        firstName: first_name.value,
        lastName: last_name.value,
        email: email.value,
        mobilePhone: mobile_phone.value,
        homePhone: home_phone.value,
        workPhone: work_phone.value,
        address: address.value
      });

      if (!updated) throw new Error("Update failed.");

      CURRENT = updated;
      title.textContent = `${updated.first_name || ""} ${updated.last_name || ""}`.trim() || "Customer Profile";
      subtitle.textContent = updated.email || "";

      showOk("Saved");
    } catch(e){
      console.error(e);
      showError(e?.message || "Save failed.");
    }
  });

  btnDelete.addEventListener("click", async () => {
    if (!confirm("Delete this customer? This cannot be undone.")) return;

    try{
      await ensureCustomerDataLoaded();

      await window.deleteCustomerInSupabase(id);
      location.href = "./customers.html";
    } catch(e){
      console.error(e);
      showError(e?.message || "Delete failed.");
    }
  });

  loadCustomer();
</script>

</body>
</html>
